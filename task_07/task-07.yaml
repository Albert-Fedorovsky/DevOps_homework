#-------------------------------------------------------------------------------
# AWS CloudFormation template
# Author: Albert Fedorovsky
# Resouces:
#   Network Layer:
#     - VPC - 1 item
#     - Internet Gateway - 1 item
#     - Subnets - 2 items
#     - RouteTables - 1 item
#   Resouces:
#     - EC2 instances - 2 items
#     - Application loadbalancer - 1 item
#-------------------------------------------------------------------------------

AWSTemplateFormatVersion: 2010-09-09
Description: "Network: VPC, Subnets + RouteTables, Internet + NAT Gateway"

Metadata:
 AWS::CloudFormation::Interface:
    ParameterGroups:
      -
        Label:
          default: "Network Configuration"
        Parameters:
          - Environment
          - VPCBlock
      -
        Label:
          default: "Subnets CIDR Blocks"
        Parameters:
          - PublicSubnetACIDR
          - PublicSubnetBCIDR
      -
        Label:
          default: "EC2 instances parameters"
        Parameters:
          - EC2AMI
          - EC2Type
          - S3BucketReference

Parameters:
  Environment:
    Type: String
    Default: "My-VPC"

  VPCBlock:
    Type: String
    Default: '10.0.0.0/16'

  PublicSubnetACIDR:
    Type: String
    Default: '10.0.10.0/24'
    Description: "Public Subnet-A CIDR"

  PublicSubnetBCIDR:
    Type: String
    Default: '10.0.20.0/24'
    Description: "Public Subnet-B CIDR"

  EC2AMI:
    Type: String
    Default: 'ami-05d34d340fb1d89e5'
    Description: "Amazon Linux 2 AMI (HVM) - Kernel 5.10, SSD Volume Type (64-bit x86)"

  EC2Type:
    Type: String
    Default: 't2.micro'
    Description: "Type of instance (InstanceType)"

  S3BucketReference:
    Type: String
    Default: 't2.micro'
    Description: "Link to S3 storing index.html"

Resources:

#===================================== VPC =====================================
  VPC:
    Type: AWS::EC2::VPC
    Properties: # Attach Primary CIDR Block
      CidrBlock: !Ref VPCBlock
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Ref Environment

#================================= SecurityGroup ===============================
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-security-group.html#cfn-ec2-securitygroup-securitygroupegress
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-security-group-ingress.html
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-security-group-egress.html
  InstanceSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow http connections.
      VpcId:
         Ref: VPC
      SecurityGroupIngress:
      - Description: Allow incoming http connections.
        IpProtocol: tcp
        CidrIp: 0.0.0.0/0
        FromPort: 80
        ToPort: 80
      SecurityGroupEgress:
      - Description: Allow outcoming http connections.
        IpProtocol: tcp
        CidrIp: 0.0.0.0/0
        FromPort: 80
        ToPort: 80
  IntboundRule1:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      CidrIp: 0.0.0.0/0
      Description: Allow incoming SSH connections.
      FromPort: 22
      GroupId: !Ref InstanceSecurityGroup
      IpProtocol: tcp
      ToPort: 22
  # IntboundRule2:
    # Type: 'AWS::EC2::SecurityGroupIngress'
    # Properties:
      # CidrIp: 0.0.0.0/0
      # Description: Allow incoming ping from any hosts.
      # FromPort: -1
      # GroupId: !Ref InstanceSecurityGroup
      # IpProtocol: icmp
      # ToPort: -1
  OutboundRule1:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      CidrIp: 0.0.0.0/0
      Description: Allows outcoming ping to any hosts.
      GroupId: !Ref InstanceSecurityGroup
      FromPort: -1
      IpProtocol: icmp
      ToPort: -1
  OutboundRule2:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      CidrIp: 0.0.0.0/0
      Description: Allows any outcoming connections.
      GroupId: !Ref InstanceSecurityGroup
      FromPort: -1
      IpProtocol: -1
      ToPort: -1

#============================== Internet Gateway ===============================
  GatewayInternet:
    Type: "AWS::EC2::InternetGateway"
    Properties:
      Tags:
        - Key: Name
          Value: !Ref Environment

  GatewayAttachmentInternet: # Attachment IGW to VPC
    Type: "AWS::EC2::VPCGatewayAttachment"
    Properties:
      VpcId:  !Ref VPC
      InternetGatewayId: !Ref GatewayInternet

#============================= Public RouteTables ==============================
  RouteTableForPublicSubnet: # Creation of Empty Route Table
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Join [ " ", [ !Ref Environment, "PublicRouteTable" ] ]

  RoutesForPublicRouteTable: # Creation and Attachment of Routes for Route Table
    Type: "AWS::EC2::Route"
    DependsOn: GatewayAttachmentInternet
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref GatewayInternet
      RouteTableId: !Ref RouteTableForPublicSubnet

#================= Associate Public Route for Public Subnets ===================
  RouteAssociationPublicA:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      RouteTableId: !Ref RouteTableForPublicSubnet
      SubnetId: !Ref PublicSubnetA

  RouteAssociationPublicB:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      RouteTableId: !Ref RouteTableForPublicSubnet
      SubnetId: !Ref PublicSubnetB

#=============================== ALL Subnets ===================================
  PublicSubnetA:
    Type: "AWS::EC2::Subnet"
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [ 0, "Fn::GetAZs": { Ref: "AWS::Region" } ]
      CidrBlock: !Ref "PublicSubnetACIDR"
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Join [ "", [ !Ref Environment, "-Public-A" ] ]
        - Key: kubernetes.io/role/elb
          Value: 1

  PublicSubnetB:
    Type: "AWS::EC2::Subnet"
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [ 1, "Fn::GetAZs": { Ref: "AWS::Region" } ]
      CidrBlock: !Ref "PublicSubnetBCIDR"
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Join [ "", [ !Ref Environment, "-Public-B" ] ]
        - Key: kubernetes.io/role/elb
          Value: 1

#===================== S3 bucket for website hosting ===========================
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/quickref-s3.html
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-s3-bucket.html#cfn-s3-bucket-accesscontrol
#https://aws.amazon.com/ru/premiumsupport/knowledge-center/ec2-instance-access-s3-bucket/
#https://docs.aws.amazon.com/efs/latest/ug/wt1-test.html
#https://devacademy.ru/article/razbiraemsya-v-http-proksi-nginx-balansirovke-nagruzki-buferizatsii-i-keshirovanii/
  # S3Bucket:
    # Type: AWS::S3::Bucket
    # Properties:
      # AccessControl: PublicRead
      # WebsiteConfiguration:
        # IndexDocument: index.html
        # ErrorDocument: error.html
    # DeletionPolicy: Retain
  # BucketPolicy:
    # Type: AWS::S3::BucketPolicy
    # Properties:
      # PolicyDocument:
        # Id: MyPolicy
        # Version: 2012-10-17
        # Statement:
          # - Sid: PublicReadForGetBucketObjects
            # Effect: Allow
            # Principal: '*'
            # Action: 's3:GetObject'
            # Resource: !Join
              # - ''
              # - - 'arn:aws:s3:::'
                # - !Ref S3Bucket
                # - /*
      # Bucket: !Ref S3Bucket

# ================================ IAM Role ====================================
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-role.html
# https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements.html
# https://docs.aws.amazon.com/AmazonS3/latest/userguide/using-with-s3-actions.html
  RootRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      Policies:
        - PolicyName: root
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: '*'
                Resource: '*'

# =========================== IAM InstanceProfile ==============================
  RootInstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - !Ref RootRole

#=============================== EC2 instances =================================
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-instance.html
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-network-iface-embedded.html
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-sub.html
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-base64.html
#https://coderoad.ru/57784287/%D0%9A%D0%B0%D0%BA-%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D1%8C-NGINX-%D0%BD%D0%B0-AWS-EC2-Linux-2
#https://tecadmin.net/mount-s3-bucket-centosrhel-ubuntu-using-s3fs/

  Ec2Instance1:
    Type: AWS::EC2::Instance
    Properties:
      IamInstanceProfile: !Ref RootInstanceProfile
      ImageId: !Ref EC2AMI
      InstanceType: !Ref EC2Type
      KeyName: Frankfurt-rsa-key-pair
      NetworkInterfaces:
        - DeviceIndex: "0"
          GroupSet:
            - Ref: InstanceSecurityGroup
          SubnetId:
            Ref: PublicSubnetA
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash -xe
            echo ${AWS::StackName} > /home/ec2-user/StackName.txt
            yum update -y
            amazon-linux-extras list | grep nginx
            amazon-linux-extras enable nginx1
            yum clean metadata
            yum -y install nginx
            nginx -v
            echo -E '<!DOCTYPE html><html><head><META HTTP-EQUIV="Content-Type"CONTENT="text/html;charset=UTF8"><title>Andersen DevOps cource: task_07</title><style type= "text/css"></style> </head><script type= "text/javascript" language="JavaScript"> </script><body><h1>task_07</h1>This is the first (script) EC2 instance deployed to connect to a load balancer.</body></html>' > /usr/share/nginx/html/index.html
            systemctl enable nginx.service
            systemctl start nginx.service
            aws s3 cp s3://task-07/index.html /usr/share/nginx/html/

  Ec2Instance2:
    Type: AWS::EC2::Instance
    Properties:
      IamInstanceProfile: !Ref RootInstanceProfile
      ImageId: !Ref EC2AMI
      InstanceType: !Ref EC2Type
      KeyName: Frankfurt-rsa-key-pair
      NetworkInterfaces:
        - DeviceIndex: "0"
          GroupSet:
            - Ref: InstanceSecurityGroup
          SubnetId:
            Ref: PublicSubnetB
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash -xe
            echo ${AWS::StackName} > /home/ec2-user/StackName.txt
            yum update -y
            amazon-linux-extras list | grep nginx
            amazon-linux-extras enable nginx1
            yum clean metadata
            yum -y install nginx
            nginx -v
            echo -E '<!DOCTYPE html><html><head><META HTTP-EQUIV="Content-Type"CONTENT="text/html;charset=UTF8"><title>Andersen DevOps cource: task_07</title><style type= "text/css"></style> </head><script type= "text/javascript" language="JavaScript"> </script><body><h1>task_07</h1>This is the second (script) EC2 instance deployed to connect to a load balancer.</body></html>' > /usr/share/nginx/html/index.html
            systemctl enable nginx.service
            systemctl start nginx.service
            aws s3 cp s3://task-07/index2.html /usr/share/nginx/html/index.html

#=============================== Load balancer =================================
#https://aws.amazon.com/ru/elasticloadbalancing/
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-elb.html
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/quickref-elb.html
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-listener.html
#https://computingforgeeks.com/configure-aws-application-load-balancer-with-cloudformation/
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-listenerrule.html
  # MyLoadBalancer:
    # Type: AWS::ElasticLoadBalancing::LoadBalancer
    # DependsOn: GatewayAttachmentInternet
    # Properties:
      # Subnets:
      # - Ref: PublicSubnetA
      # - Ref: PublicSubnetB
      # Instances:
      # - Ref: Ec2Instance1
      # - Ref: Ec2Instance2
      # SecurityGroups:
        # - Ref: InstanceSecurityGroup
      # Listeners:
      # - LoadBalancerPort: '80'
        # InstancePort: '80'
        # Protocol: HTTP
      # HealthCheck:
        # Target: HTTP:80/
        # HealthyThreshold: '2'
        # UnhealthyThreshold: '3'
        # Interval: '15'
        # Timeout: '4'

  ALBSecurityGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "security group for ALB"
      GroupName: "test-ALB-SG"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        -
          CidrIp: "0.0.0.0/0"
          FromPort: 80
          IpProtocol: "tcp"
          ToPort: 80
        # -
          # CidrIp: "0.0.0.0/0"
          # FromPort: 443
          # IpProtocol: "tcp"
          # ToPort: 443

  ApplicationLoadBalancer:
    Type: "AWS::ElasticLoadBalancingV2::LoadBalancer"
    Properties:
      Name: "Application-Load-Balancer"
      Scheme: "internet-facing"
      Type: "application"
      Subnets:
        - !Ref PublicSubnetA
        - !Ref PublicSubnetB
      SecurityGroups:
        - !Ref ALBSecurityGroup
      # IpAddressType: "ipv4"
      # LoadBalancerAttributes:
        # -
          # Key: "access_logs.s3.enabled"
          # Value: "false"
        # -
          # Key: "idle_timeout.timeout_seconds"
          # Value: "60"
        # -
          # Key: "deletion_protection.enabled"
          # Value: "false"
        # -
          # Key: "routing.http2.enabled"
          # Value: "true"
        # -
          # Key: "routing.http.drop_invalid_header_fields.enabled"
          # Value: "false"

  TargetGroup1:
    Type: "AWS::ElasticLoadBalancingV2::TargetGroup"
    Properties:
      # HealthCheckIntervalSeconds: 30
      # HealthCheckPath: "/"
      Port: 80
      Protocol: "HTTP"
      # HealthCheckPort: "traffic-port"
      # HealthCheckProtocol: "HTTP"
      # HealthCheckTimeoutSeconds: 5
      # UnhealthyThresholdCount: 2
      # TargetType: "instance"
      # Matcher:
          # HttpCode: "200"
      # HealthyThresholdCount: 5
      VpcId: !Ref VPC
      # Name: "target-group-1"
      # HealthCheckEnabled: true
      # TargetGroupAttributes:
        # -
          # Key: "stickiness.enabled"
          # Value: "false"
        # -
          # Key: "deregistration_delay.timeout_seconds"
          # Value: "300"
        # -
          # Key: "stickiness.type"
          # Value: "lb_cookie"
        # -
          # Key: "stickiness.lb_cookie.duration_seconds"
          # Value: "86400"
        # -
          # Key: "slow_start.duration_seconds"
          # Value: "0"
        # -
          # Key: "load_balancing.algorithm.type"
          # Value: "round_robin"

  # TargetGroup2:
    # Type: "AWS::ElasticLoadBalancingV2::TargetGroup"
    # Properties:
      # HealthCheckIntervalSeconds: 30
      # HealthCheckPath: "/"
      # Port: 80
      # Protocol: "HTTP"
      # HealthCheckPort: "traffic-port"
      # HealthCheckProtocol: "HTTP"
      # HealthCheckTimeoutSeconds: 5
      # UnhealthyThresholdCount: 2
      # TargetType: "instance"
      # Matcher:
          # HttpCode: "200"
      # HealthyThresholdCount: 5
      # VpcId: !Ref VPC
      # Name: "target-group-2"
      # HealthCheckEnabled: true
      # TargetGroupAttributes:
        # -
          # Key: "stickiness.enabled"
          # Value: "false"
        # -
          # Key: "deregistration_delay.timeout_seconds"
          # Value: "300"
        # -
          # Key: "stickiness.type"
          # Value: "lb_cookie"
        # -
          # Key: "stickiness.lb_cookie.duration_seconds"
          # Value: "86400"
        # -
          # Key: "slow_start.duration_seconds"
          # Value: "0"
        # -
          # Key: "load_balancing.algorithm.type"
          # Value: "round_robin"

  ListenerRule1:
    Type: "AWS::ElasticLoadBalancingV2::ListenerRule"
    Properties:
      # Priority: "1"
      ListenerArn: !Ref HTTPSListener
      Conditions:
        -
          # Field: "host-header"
          Field: "http-header"
          Values:
            - "test1.blog.avrcr.com"
      Actions:
        -
          Type: "forward"
          TargetGroupArn: !Ref TargetGroup1
          # Order: 1
          ForwardConfig:
            TargetGroups:
              -
                TargetGroupArn: !Ref Test1TargetGroup
                Weight: 1
            TargetGroupStickinessConfig:
                Enabled: false

  ListenerRule2:
    Type: "AWS::ElasticLoadBalancingV2::ListenerRule"
    Properties:
      Priority: "2"
      ListenerArn: !Ref HTTPSListener
      Conditions:
        -
          Field: "host-header"
          Values:
            - "test2.blog.com"
      Actions:
        -
          Type: "forward"
          TargetGroupArn: !Ref TargetGroup2
          Order: 1
          ForwardConfig:
            TargetGroups:
              -
                TargetGroupArn: !Ref Test2TargetGroup
                Weight: 1
            TargetGroupStickinessConfig:
                Enabled: false

  HTTPSListener:
    Type: "AWS::ElasticLoadBalancingV2::Listener"
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: "HTTPS"
      SslPolicy: "ELBSecurityPolicy-2016-08"
      Certificates:
        -
          CertificateArn: arn:aws:acm:eu-central-1:**************:certificate/*********************

      DefaultActions:
        -
          Order: 1
          TargetGroupArn: !Ref Test1TargetGroup
          Type: "forward"

  HTTPListener:
    Type: "AWS::ElasticLoadBalancingV2::Listener"
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: "HTTP"
      DefaultActions:
        -
          Order: 1
          RedirectConfig:
            Protocol: "HTTPS"
            Port: "443"
            Host: "#{host}"
            Path: "/#{path}"
            Query: "#{query}"
            StatusCode: "HTTP_301"
          Type: "redirect"

#================================== OUTPUTS ====================================
Outputs:
  VPC:
    Description: ID for the VPC
    Value: !Ref VPC
    Export:
      Name: !Join [ "-", [ !Ref "Environment", "VPC" ] ]

  VPCBlock1:
    Description: Primary CIDR block for the VPC
    Value: !GetAtt VPC.CidrBlock
    Export:
      Name: !Join [ "-", [ !Ref "Environment", "CIDR1" ] ]

  PublicA:
    Description: ID for Public Subnet A
    Value: !Ref PublicSubnetA
    Export:
      Name: !Join [ "-", [ !Ref "Environment", "PublicSubnetA" ] ]

  PublicB:
    Description: ID for Public Subnet B
    Value: !Ref PublicSubnetB
    Export:
      Name: !Join [ "-", [ !Ref "Environment", "PublicSubnetB" ] ]

  # WebsiteURL:
    # Value: !GetAtt
      # - S3Bucket
      # - WebsiteURL
    # Description: URL for website hosted on S3
  # S3BucketSecureURL:
    # Value: !Join
      # - ''
      # - - 'https://'
        # - !GetAtt
          # - S3Bucket
          # - DomainName
    # Description: Name of S3 bucket to hold website content
  ALB:
    Description: The created loadbalancer
    Value: !Ref ApplicationLoadBalancer

  TargetGroup1:
    Description: The created TargetGroup 1
    Value: !Ref Test1TargetGroup

  TargetGroup2:
    Description: The created TargetGroup 2
    Value: !Ref Test2TargetGroup

  LoadBalancerSecurityGroup:
    Description: the securty group for the ALB
    Value: !Ref ALBSecurityGroup